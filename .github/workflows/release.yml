name: Release (auto version bump)

on:
  pull_request:
    types: [closed]
    branches: [master]

permissions:
  contents: write
  pull-requests: read

# Prevent two merges from bumping version at the same time
concurrency:
  group: release-bump-master
  cancel-in-progress: false

jobs:
  bump_version:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest

    steps:
      - name: Checkout master
        uses: actions/checkout@v4
        with:
          ref: master
          fetch-depth: 0

      - name: Ensure local master is up-to-date
        run: |
          git fetch origin master --tags
          git checkout master
          git reset --hard origin/master

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Configure git identity
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Determine bump type from PR labels (default patch)
        id: bump
        run: |
          LABELS='${{ toJson(github.event.pull_request.labels) }}'
          TYPE="patch"
          echo "$LABELS" | grep -q '"name":"semver:major"' && TYPE="major"
          echo "$LABELS" | grep -q '"name":"semver:minor"' && TYPE="minor"
          echo "$LABELS" | grep -q '"name":"semver:patch"' && TYPE="patch"
          echo "type=$TYPE" >> $GITHUB_OUTPUT
          echo "Bump type: $TYPE"

      - name: Bump version, commit, tag (retry if tag exists)
        id: release
        shell: bash
        run: |
          set -euo pipefail

          TYPE="${{ steps.bump.outputs.type }}"
          echo "Bump type: $TYPE"

          # Make sure tags are present
          git fetch --tags

          # We'll retry a few times in case the target tag already exists
          MAX_RETRIES=5
          ATTEMPT=1

          while [ "$ATTEMPT" -le "$MAX_RETRIES" ]; do
            echo "Attempt $ATTEMPT/$MAX_RETRIES"

            # Bump version in package.json only (no tag/commit yet)
            npm version "$TYPE" --no-git-tag-version

            VERSION="$(node -p "require('./package.json').version")"
            TAG="v$VERSION"

            # If tag already exists, revert package.json and try again
            if git rev-parse "$TAG" >/dev/null 2>&1; then
              echo "Tag $TAG already exists. Reverting and retrying..."
              git checkout -- package.json package-lock.json yarn.lock pnpm-lock.yaml 2>/dev/null || true

              # For minor/major, retrying with same TYPE may land on same version again
              # but npm version will move forward if package.json was reverted.
              ATTEMPT=$((ATTEMPT + 1))
              continue
            fi

            # Commit version bump
            git add package.json package-lock.json yarn.lock pnpm-lock.yaml 2>/dev/null || true
            git commit -m "chore(release): $TAG"

            # Create annotated tag
            git tag "$TAG" -m "$TAG"

            echo "version=$VERSION" >> "$GITHUB_OUTPUT"
            echo "tag=$TAG" >> "$GITHUB_OUTPUT"
            echo "✅ Created release $TAG"
            break
          done

          if [ "$ATTEMPT" -gt "$MAX_RETRIES" ]; then
            echo "❌ Failed to find a free tag after $MAX_RETRIES attempts."
            exit 1
          fi

      - name: Push commit + tags
        run: |
          git push origin master --follow-tags
