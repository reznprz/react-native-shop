name: PR Preflight (Typecheck + Bundle)

on:
  pull_request:
    branches: [develop, master]

permissions:
  contents: read

concurrency:
  group: pr-preflight-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  preflight:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: yarn

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      # --- TypeScript check ---
      # Requires "typecheck" script in package.json:
      # "typecheck": "tsc -p tsconfig.json --noEmit"
      - name: Typecheck (non-blocking for now)
        continue-on-error: true
        run: yarn typecheck

      # --- Create CI env file (no secrets) ---
      # This prevents runtime config crashes during bundling if your config expects EXPO_PUBLIC_*
      - name: Create .env.ci
        run: |
          cat > .env.ci << EOF
          EXPO_PUBLIC_ENV=uat
          EXPO_PUBLIC_DEBUG=false
          EXPO_PUBLIC_API_BASE_URL=https://example.invalid/api
          EXPO_PUBLIC_TOKEN_BASE_URL=https://example.invalid
          EOF

      # --- Bundling preflight (this is what catches missing modules/import errors) ---
      - name: Bundle check (Expo export)
        env:
          EXPO_NO_DOTENV: "1"
          DOTENV_FILE: ".env.ci"
        run: |
          npx expo export \
            --platform ios \
            --platform android \
            --output-dir /tmp/dist
