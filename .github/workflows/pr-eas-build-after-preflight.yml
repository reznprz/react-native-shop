name: PR EAS Build (Android) after Preflight
run-name: PR EAS Build • ${{ github.event.workflow_run.head_branch }} • ${{ github.event.workflow_run.conclusion }}

on:
  workflow_run:
    workflows: ["PR Preflight (Config + Bundle)"]
    types: [completed]

permissions:
  contents: read

concurrency:
  group: pr-eas-build-after-preflight-${{ github.event.workflow_run.head_branch }}
  cancel-in-progress: true

jobs:
  route:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    outputs:
      base_ref: ${{ steps.pr.outputs.base_ref }}

    steps:
      - name: Extract PR base branch from workflow_run
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const prs = context.payload.workflow_run.pull_requests || [];
            if (!prs.length) {
              core.setOutput("base_ref", "");
              console.log("No PR attached (likely workflow_dispatch). Skipping downstream build.");
              return;
            }
            const pr = prs[0];
            core.setOutput("base_ref", pr.base.ref);
            console.log(`PR base: ${pr.base.ref}`);

  eas_build_uat:
    needs: route
    if: ${{ needs.route.outputs.base_ref == 'develop' }}
    uses: ./.github/workflows/reusable-eas-build-android.yml
    with:
      profile: uat
    secrets: inherit

  eas_build_prod:
    needs: route
    if: ${{ needs.route.outputs.base_ref == 'master' }}
    uses: ./.github/workflows/reusable-eas-build-android.yml
    with:
      profile: production
    secrets: inherit
