name: PR EAS Build (Android) after Preflight
run-name: PR EAS Build • ${{ github.event.workflow_run.head_branch }} • ${{ github.event.workflow_run.conclusion }}

on:
  workflow_run:
    workflows: ["PR Preflight (Config + Bundle)"] # MUST match preflight workflow name EXACTLY
    types: [completed]

permissions:
  contents: read

concurrency:
  group: pr-eas-build-after-preflight-${{ github.event.workflow_run.head_branch }}
  cancel-in-progress: true

jobs:
  route:
    # Only run when preflight succeeded AND it came from a PR event
    if: >-
      ${{
        github.event.workflow_run.conclusion == 'success' &&
        github.event.workflow_run.event == 'pull_request'
      }}
    runs-on: ubuntu-latest
    outputs:
      base_ref: ${{ steps.pr.outputs.base_ref }}
      pr_number: ${{ steps.pr.outputs.pr_number }}

    steps:
      - name: Extract PR info from workflow_run payload
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const prs = context.payload.workflow_run.pull_requests || [];
            if (!prs.length) {
              core.setFailed("No PR found on workflow_run payload (was preflight triggered by PR?).");
              return;
            }
            // Most of the time there is exactly one
            const pr = prs[0];
            core.setOutput("pr_number", String(pr.number));
            core.setOutput("base_ref", pr.base.ref);
            console.log(`PR #${pr.number} base: ${pr.base.ref}`);

  eas_build_uat:
    needs: route
    if: ${{ needs.route.outputs.base_ref == 'develop' }}
    uses: ./.github/workflows/reusable-eas-build-android.yml
    with:
      profile: uat
    secrets: inherit

  eas_build_prod:
    needs: route
    if: ${{ needs.route.outputs.base_ref == 'master' }}
    uses: ./.github/workflows/reusable-eas-build-android.yml
    with:
      profile: production
    secrets: inherit
